<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vistoria Placas ‚Äî VITORIA SALINAS</title>

<style>
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff;
    --brand:#c0362c; /* vermelho do t√≠tulo do PDF */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}

  .app{max-width:1100px;margin:20px auto 80px;padding:0 16px}
  .grid{display:grid;gap:16px}
  .floating{position:fixed;bottom:16px;right:16px;z-index:30}
  .btn,label.btn{border:1px solid var(--line);background:var(--card);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}

  /* A√ß√µes no final da p√°gina */
  .page-actions{display:flex;justify-content:center;margin:24px 0 40px;gap:10px}
  .btn.big{padding:14px 18px;font-size:16px;border-radius:999px}

  /* --- FICHA (tela) --- */
  .ficha{border:1px solid var(--line);border-radius:16px;background:var(--card);padding:16px;box-shadow:0 1px 1px rgba(0,0,0,.04),0 8px 24px rgba(2,6,23,.06)}
  .pdf-head{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:8px}
  .pdf-title{font-weight:900;letter-spacing:.3px;text-transform:uppercase;color:var(--brand)}
  .pdf-year{font-weight:900;text-transform:uppercase}
  .meta{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:6px 0 10px}
  .field{display:flex;align-items:center;gap:8px;font-weight:800}
  .label{font-size:12px;color:var(--muted);letter-spacing:.35px;text-transform:uppercase;white-space:nowrap}
  .line-input{flex:1;min-width:40px;border:1px solid var(--line);background:var(--card);padding:8px 10px;border-radius:10px;outline:0}
  .items{display:grid;grid-template-columns:1fr 1fr;gap:10px 18px;margin-top:8px}
  .rowitem{display:grid;grid-template-columns:20px 1fr;gap:10px;align-items:center}
  .rowitem input[type="checkbox"]{width:18px;height:18px}
  .note{margin-left:28px;margin-top:-4px}
  .note .line-input{border-style:dashed}
  .footer{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-top:12px}
  .foto-wrap{display:flex;align-items:center;gap:8px;font-weight:800}
  .divider{height:1px;background:var(--line);margin:12px 0}

  /* --- Mobile --- */
  @media (max-width: 768px){
    .app{margin:10px auto 40px;padding:0 8px}
    .meta{grid-template-columns:1fr 1fr}
    .items{grid-template-columns:1fr}
    .footer{grid-template-columns:1fr}
  }

  /* --- IMPRESS√ÉO / PDF --- */
  @media print{
    :root{--bg:#fff;--ink:#000;--muted:#000;--line:#000;--brand:#b63026}
    body{background:#fff;color:#000;font-family:Arial,Helvetica,sans-serif}
    .no-print, .floating{display:none !important}
    .app{max-width:none;padding:0;margin:0}
    @page{size:A4 portrait;margin:10mm}

    /* DUAS FICHAS POR P√ÅGINA */
    .ficha{border:0;border-radius:0;box-shadow:none;padding:0 2mm 0 0;break-inside:avoid;height:130mm}
    .ficha:nth-of-type(2n){break-after:page;}
    .divider{height:1.2pt;background:#000;margin:8mm 0}

    .pdf-title{font-size:17pt;letter-spacing:.2pt}
    .pdf-year{font-size:17pt}
    .label{font-size:9pt;color:#000}
    .meta{grid-template-columns:repeat(12,1fr);gap:6pt;margin:6pt 0 2mm}
    .items{gap:6pt 16pt}

    /* Caixas quadradas com X */
    .rowitem input[type="checkbox"]{
      appearance:none;-webkit-appearance:none;width:12pt;height:12pt;border:1.4pt solid #000;border-radius:2pt;background:#fff;margin:0;position:relative
    }
    .rowitem input[type="checkbox"]:checked::after{
      content:"X";position:absolute;left:1.5pt;top:-2pt;font-size:12pt;font-weight:900;color:#000;
    }

    /* Entradas viram LINHAS */
    .line-input{
      border:none !important;border-bottom:1.6pt solid #000 !important;border-radius:0 !important;
      padding:0 !important;height:16pt !important;background:transparent !important;color:#000 !important;font-size:11pt !important
    }
    .note .line-input{border-bottom:1.2pt dashed #000 !important;height:14pt !important}

    /* 'ANO' (campo) n√£o aparece no PDF ‚Äî s√≥ o do cabe√ßalho */
    .hide-print{display:none !important}

    /* 'VISTORIA POR' s√≥ no fim da 2¬™ ficha de cada p√°gina */
    .vistoria-por{display:none}
    .ficha:nth-of-type(2n) .vistoria-por{display:block;margin-top:6mm}
  }
</style>
</head>

<body>
  <div class="app" id="app">
    <div class="grid" id="fichas"></div>

    <!-- Bot√£o de gerar PDF no final da p√°gina -->
    <div class="page-actions no-print">
      <button class="btn big" id="printBottomBtn">üñ®Ô∏è Gerar PDF</button>
    </div>

    <!-- Bot√£o flutuante (opcional) para adicionar ficha -->
    <button class="floating btn no-print" id="floatingNew">‚ûï Nova ficha</button>
  </div>

  <!-- TEMPLATE -->
  <template id="tpl">
    <section class="ficha" data-ficha>
      <!-- Cabe√ßalho PDF -->
      <div class="pdf-head">
        <div class="pdf-title">VISTORIA PLACAS SALINAS</div>
        <div class="pdf-year">ANO: <span data-year>2025</span></div>
      </div>

      <!-- Metadados -->
      <div class="meta">
        <div class="field hide-print" style="grid-column:span 2">
          <span class="label">ANO</span>
          <input class="line-input" name="ano" type="number" min="1900" max="2100" value="2025">
        </div>
        <div class="field" style="grid-column:span 2"><span class="label">N.¬∫</span><input class="line-input" name="numero"></div>
        <div class="field" style="grid-column:span 6"><span class="label">LOCAL</span><input class="line-input" name="local"></div>
        <div class="field" style="grid-column:span 2"><span class="label">REF.</span><input class="line-input" name="ref"></div>
        <div class="field" style="grid-column:span 2"><span class="label">PLACA</span><input class="line-input" name="placa"></div>
      </div>

      <!-- Checklist + notas (sem texto) -->
      <div class="items">
        <div>
          <div class="rowitem"><input type="checkbox" name="REFORMA"><label>REFORMA</label></div>
          <div class="note"><input class="line-input" data-note="REFORMA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="MOLDURA"><label>MOLDURA</label></div>
          <div class="note"><input class="line-input" data-note="MOLDURA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="ESCORA"><label>ESCORA</label></div>
          <div class="note"><input class="line-input" data-note="ESCORA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="PERNAMANCA_PLACA"><label>PERNAMANCA PLACA</label></div>
          <div class="note"><input class="line-input" data-note="PERNAMANCA_PLACA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="PIQUETE"><label>PIQUETE</label></div>
          <div class="note"><input class="line-input" data-note="PIQUETE" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="PLAQUINHA"><label>PLAQUINHA</label></div>
          <div class="note"><input class="line-input" data-note="PLAQUINHA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="NUMERO_PLACA"><label>N√öMERO PLACA</label></div>
          <div class="note"><input class="line-input" data-note="NUMERO_PLACA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="MATO"><label>MATO</label></div>
          <div class="note"><input class="line-input" data-note="MATO" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="MODULO_PLACA"><label>M√ìDULO PLACA</label></div>
          <div class="note"><input class="line-input" data-note="MODULO_PLACA" placeholder=""></div>
        </div>
        <div>
          <div class="rowitem"><input type="checkbox" name="ESTEIOS"><label>ESTEIOS</label></div>
          <div class="note"><input class="line-input" data-note="ESTEIOS" placeholder=""></div>
        </div>
      </div>

      <!-- Rodap√© -->
      <div class="footer">
        <div class="field"><span class="label">PROX. VISTORIA</span><input class="line-input" name="prox_vistoria" placeholder="__/__/____" inputmode="numeric" maxlength="10"></div>
        <div class="foto-wrap">
          <input type="checkbox" class="foto-box" name="foto"><span>FOTO</span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Aparece no fim da 2¬™ ficha (PDF) -->
      <div class="vistoria-por">
        <div class="field" style="max-width:460px"><span class="label">VISTORIA POR</span><input class="line-input" name="vistoria_por" placeholder=""></div>
      </div>
    </section>
  </template>

<script>
  const LS_KEY = 'vistoria_placas_v4';
  const fichas = document.getElementById('fichas');
  const tpl = document.getElementById('tpl');

  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const pad4 = n => String(n).padStart(4,'0');
  const uid = () => Math.random().toString(36).slice(2);

  function addFicha(prefill={}){
    const frag = tpl.content.cloneNode(true);
    const sec = $('[data-ficha]', frag);
    sec.dataset.id = prefill.id || uid();

    // Prefill
    setVal(sec,'ano', prefill.ano ?? 2025);
    setVal(sec,'numero', prefill.numero || pad4(nextSeq()));
    ['local','ref','placa','prox_vistoria','vistoria_por'].forEach(n=> setVal(sec,n, prefill[n]||''));

    // checkboxes + notas
    $$('.rowitem input[type="checkbox"]', sec).forEach(cb=>{
      cb.checked = !!prefill[cb.name];
      const note = $(`.note .line-input[data-note="${cb.name}"]`, sec);
      if (note) note.value = prefill[`note_${cb.name}`] || '';
      const toggle=()=> note && (note.disabled = !cb.checked);
      toggle(); cb.addEventListener('change',()=>{ toggle(); saveDebounced(); });
    });

    // ANO do cabe√ßalho segue o campo 'ano'
    const yearSpan = $('[data-year]', sec);
    const anoInput = $('[name="ano"]', sec);
    const syncYear = ()=> yearSpan.textContent = anoInput.value || '2025';
    syncYear(); anoInput.addEventListener('input', syncYear);

    // Listeners gerais
    $$('input', sec).forEach(i=> i.addEventListener('input', saveDebounced));

    fichas.appendChild(frag);
    saveDebounced();
  }

  function setVal(root,name,val){
    const el = root.querySelector(`[name="${name}"]`);
    if(el){ if(el.type==='checkbox') el.checked=!!val; else el.value=val; }
  }

  function serialize(){
    return $$('#fichas [data-ficha]').map(sec=>{
      const data = { id: sec.dataset.id };
      $$('input', sec).forEach(el=>{
        if(el.dataset.note) data[`note_${el.dataset.note}`] = el.value;
        else data[el.name] = (el.type==='checkbox') ? el.checked : el.value;
      });
      return data;
    });
  }

  function rebuild(arr){
    fichas.innerHTML = '';
    (arr||[]).forEach(d=> addFicha(d));
    if(!arr || !arr.length) addFicha();
  }

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(serialize())); }
  let t; function saveDebounced(){ clearTimeout(t); t = setTimeout(save, 250); }

  function nextSeq(){
    const nums = serialize().map(o=>parseInt(o.numero,10)).filter(n=>!isNaN(n));
    return (nums.length ? Math.max(...nums) : 0) + 1;
  }

  // Bot√µes
  document.getElementById('floatingNew').addEventListener('click', ()=> addFicha());
  document.getElementById('printBottomBtn').addEventListener('click', ()=> window.print());

  // Atalhos
  window.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='p'){ e.preventDefault(); window.print(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); addFicha(); }
  });

  // Init
  (function init(){
    const data = load();
    if(Array.isArray(data) && data.length) rebuild(data); else addFicha();
  })();
</script>
</body>
</html>
